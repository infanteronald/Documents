# ====================================================
# ğŸ§¹ FUNCIONES DE LIMPIEZA PARA SEQUOIA SPEED
# ====================================================

# FunciÃ³n principal de limpieza completa integrada
limpiar() {
    local current_dir=$(pwd)
    local project_dir="/Users/ronaldinfante/Documents/pedidos"

    # Determinar modo de ejecuciÃ³n

    # Procesar argumentos


    echo "ğŸ§¹ LIMPIADOR COMPLETO DE ARCHIVOS TEMPORALES"
    echo "ğŸ“‚ Cambiando al directorio del proyecto..."

    cd "$project_dir" || {
        echo "âŒ Error: No se pudo acceder al directorio del proyecto"
        return 1
    }

    echo "ğŸ“‚ Directorio: $(pwd)"
    echo ""

    # Configurar glob para manejar patrones sin coincidencias
    setopt NULL_GLOB

    local total=0
    local doc_count=0
    local test_count=0
    local script_count=0
    local backup_count=0
    local system_count=0
    local empty_count=0

    echo "ğŸ¯ INICIANDO LIMPIEZA POR CATEGORÃAS:"
    echo ""

    # ====================================================
    # ğŸ“„ CATEGORÃA 1: DOCUMENTACIÃ“N TEMPORAL
    # ====================================================
    echo "ğŸ“„ [1/7] DocumentaciÃ³n temporal..."
    for file in README_*.md DUMMY*.md TEST*.md EXAMPLE*.md TUTORIAL*.md; do
        if [[ -f "$file" ]]; then
            ((doc_count++))
            ((total++))
            rm -f "$file" && echo "    ğŸ—‘ï¸  Borrado: $file"
        fi
    done
    echo "    âœ… Documentos temporales: $doc_count archivos"

    # ====================================================
    # ğŸ§ª CATEGORÃA 2: ARCHIVOS DE PRUEBAS NO OFICIALES
    # ====================================================
    echo ""
    echo "ğŸ§ª [2/7] Archivos de pruebas no oficiales..."
    for file in test_*.* *.spec.* *.test.* prueba_*.* testing_*.*; do
        if [[ -f "$file" ]]; then
            ((test_count++))
            ((total++))
            rm -f "$file" && echo "    ğŸ—‘ï¸  Borrado: $file"
        fi
    done
    echo "    âœ… Archivos de prueba: $test_count archivos"

    # ====================================================
    # ğŸ“ CATEGORÃA 3: SCRIPTS TEMPORALES
    # ====================================================
    echo ""
    echo "ğŸ“ [3/7] Scripts temporales..."
    for file in script_*.* experiment_*.* draft_*.* scratch_*.* temp_*.*; do
        if [[ -f "$file" ]]; then
            ((script_count++))
            ((total++))
            rm -f "$file" && echo "    ğŸ—‘ï¸  Borrado: $file"
        fi
    done
    echo "    âœ… Scripts temporales: $script_count archivos"

    # ====================================================
    # ğŸ’¾ CATEGORÃA 4: ARCHIVOS DE RESPALDO
    # ====================================================
    echo ""
    echo "ğŸ’¾ [4/7] Archivos de respaldo..."
    for file in *.bak *.old *.backup *~ *.orig *.swp; do
        if [[ -f "$file" ]]; then
            ((backup_count++))
            ((total++))
            rm -f "$file" && echo "    ğŸ—‘ï¸  Borrado: $file"
        fi
    done
    echo "    âœ… Archivos de respaldo: $backup_count archivos"

    # ====================================================
    # ğŸ CATEGORÃA 5: ARCHIVOS DEL SISTEMA
    # ====================================================
    echo ""
    echo "ğŸ [5/7] Archivos del sistema..."
    for file in .DS_Store Thumbs.db desktop.ini .*.tmp; do
        if [[ -f "$file" ]]; then
            ((system_count++))
            ((total++))
            rm -f "$file" && echo "    ğŸ—‘ï¸  Borrado: $file"
        fi
    done

    # ====================================================
    # ğŸ“­ CATEGORÃA 6: ARCHIVOS VACÃOS
    # ====================================================
    # ğŸ“­ CATEGORÃA 6: ARCHIVOS VACÃOS (0 bytes)
    # ====================================================
    echo ""
    echo "ğŸ“­ [6/7] Archivos vacÃ­os (0 bytes)..."

    # Buscar archivos vacÃ­os excluyendo directorios importantes y archivos ocultos
    local empty_files=$(find . -maxdepth 1 -type f -size 0 -not -name ".*" -not -path "./app/*" -not -path "./public/*" -not -path "./assets/*" 2>/dev/null)

    if [[ -n "$empty_files" ]]; then
        while IFS= read -r file; do
            if [[ -f "$file" ]]; then
                # Verificar que no sea un archivo importante
                local filename=$(basename "$file")
                if [[ "$filename" != ".gitkeep" && "$filename" != ".htaccess" && "$filename" != "index.html" ]]; then
                    # Verificar que no coincida con otros patrones ya manejados
                    local skip_file=false
                    case "$filename" in
                        README_*.md|DUMMY*.md|TEST*.md|EXAMPLE*.md|TUTORIAL*.md) skip_file=true ;;
                        test_*.*|*.spec.*|*.test.*|prueba_*.*|testing_*.*) skip_file=true ;;
                        script_*.*|experiment_*.*|draft_*.*|scratch_*.*|temp_*.*) skip_file=true ;;
                        *.bak|*.old|*.backup|*~|*.orig|*.swp) skip_file=true ;;
                    esac

                    if [[ "$skip_file" == "false" ]]; then
                        ((empty_count++))
                        ((total++))
                        rm -f "$file" && echo "    ğŸ—‘ï¸  Borrado archivo vacÃ­o: $file"
                    fi
                fi
            fi
        done <<< "$empty_files"
    fi
    echo "    âœ… Archivos vacÃ­os: $empty_count archivos"
    echo "    âœ… Archivos del sistema: $system_count archivos"

    # ====================================================
    # ğŸ¤– CATEGORÃA 7: BORRATEMPORALES AUTOMÃTICO
    # ====================================================
    echo ""
    echo "ğŸ¤– [7/7] Ejecutando borratemporales..."
    echo "    ğŸš€ Ejecutando limpieza automÃ¡tica..."
    # Ejecutar borratemporales (es un alias)
    source ~/.zshrc 2>/dev/null || true
    if command -v borratemporales &> /dev/null; then
        borratemporales
    else
        # Fallback directo al script PHP
        php /Users/ronaldinfante/Documents/pedidos-development/desarrollo/scripts/borratemporales.php 2>/dev/null || echo "    âš ï¸ borratemporales no disponible"
    fi

    # ====================================================
    # ğŸ“Š RESUMEN FINAL
    # ====================================================
    echo ""
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "ğŸ“Š RESUMEN DE LIMPIEZA"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "ğŸ“„ DocumentaciÃ³n temporal: $doc_count archivos"
    echo "ğŸ§ª Archivos de prueba: $test_count archivos"
    echo "ğŸ“ Scripts temporales: $script_count archivos"
    echo "ğŸ’¾ Archivos de respaldo: $backup_count archivos"
    echo "ğŸ Archivos del sistema: $system_count archivos"
    echo "ğŸ“­ Archivos vacÃ­os: $empty_count archivos"
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    echo "âœ… Total archivos encontrados: $total"

    if [[ $total -gt 0 ]]; then
        echo "ğŸš€ Â¡Proyecto completamente limpio!"
    else
        echo "ğŸ‰ Â¡El proyecto ya estaba limpio!"
    fi
    echo "ğŸ¤– Limpieza automÃ¡tica completada con borratemporales"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

    # Restaurar configuraciÃ³n de glob
    unsetopt NULL_GLOB

    # Regresar al directorio original
    cd "$current_dir"
}

# FunciÃ³n para sincronizaciÃ³n manual con limpieza previa
sync-sequoia() {
    echo "ğŸ§¹ Ejecutando limpieza antes de sincronizar..."

    # Cambiar al directorio del proyecto
    local current_dir=$(pwd)
    local project_dir="/Users/ronaldinfante/Documents/pedidos"

    cd "$project_dir" || {
        echo "âŒ Error: No se pudo acceder al directorio del proyecto"
        return 1
    }

    # Ejecutar limpieza de archivos temporales usando funciÃ³n integrada
    echo "ğŸ—‘ï¸ Limpiando archivos temporales..."
    limpiar

    echo "ğŸ“¤ Sincronizando archivos con servidor (modo verboso)..."

    # Configurar locale para evitar warnings de perl
    export LC_ALL=C
    export LANG=C
    export LANGUAGE=

    # Usar rsync para sincronizaciÃ³n mÃ¡s eficiente
    rsync -azv \
        --exclude='.vscode/' \
        --exclude='.git/' \
        --exclude='.DS_Store' \
        --exclude='*.log' \
        --exclude='.zsh*' \
        --exclude='**/check_sftp_status.sh' \
        --exclude='**/clean-temp-files.sh' \
        --exclude='**/test_*.html' \
        --exclude='**/*_fixed.php' \
        -e "ssh -i /Users/ronaldinfante/id_rsa -p 7822" \
        /Users/ronaldinfante/Documents/pedidos/ \
        motodota@68.66.226.124:/home/motodota/sequoiaspeed.com.co/pedidos/

    # Restaurar locale original
    export LC_ALL=
    export LANG="es_ES.UTF-8"

    # Regresar al directorio original
    cd "$current_dir"

    if [[ $? -eq 0 ]]; then
        echo "âœ… SincronizaciÃ³n completada"
    else
        echo "âŒ Error en sincronizaciÃ³n"
    fi
}

echo "âœ… Funciones Sequoia Speed cargadas - Limpieza integrada"
echo "ğŸ’¡ Comandos disponibles:"
echo "   limpiar          - Limpieza completa"
echo "   sync-sequoia     - Limpieza + sincronizaciÃ³n"
