<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Bold Function Debug</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #1e1e1e; color: #fff; }
        .container { max-width: 800px; margin: 0 auto; }
        .test-section { background: #2d2d30; padding: 20px; margin: 20px 0; border-radius: 8px; }
        .log { background: #0e0e0e; padding: 10px; border-radius: 4px; font-family: monospace; margin: 10px 0; overflow-x: auto; }
        button { background: #007aff; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; margin: 10px 5px; }
        button:hover { background: #0056d3; }
        .info-pago { background: #2d2d30; padding: 15px; border-radius: 8px; margin: 15px 0; }
        .pse-bold-container { background: #333; border: 1px solid #007aff; border-radius: 8px; padding: 15px; margin: 10px 0; }
        select, input { background: #2d2d30; color: #fff; border: 1px solid #444; padding: 8px; border-radius: 4px; margin: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test Bold Function Debug</h1>
        
        <div class="test-section">
            <h2>üîß Simulaci√≥n de Formulario</h2>
            <select id="metodo_pago">
                <option value="">Seleccionar m√©todo</option>
                <option value="PSE Bold">PSE Bold</option>
                <option value="Bot√≥n Bancolombia">Bot√≥n Bancolombia</option>
                <option value="Tarjeta de Cr√©dito o D√©bito">Tarjeta de Cr√©dito o D√©bito</option>
            </select>
            
            <input type="text" name="monto" value="$150.000" placeholder="Monto">
            <input type="text" name="correo" value="test@example.com" placeholder="Email">
            <input type="text" name="nombre" value="Test User" placeholder="Nombre">
            <input type="text" name="telefono" value="3001234567" placeholder="Tel√©fono">
            <input type="text" name="direccion" value="Calle 123 #45-67" placeholder="Direcci√≥n">
            
            <div id="info_pago" class="info-pago"></div>
        </div>

        <div class="test-section">
            <h2>üéØ Controles de Test</h2>
            <button onclick="testBoldFunction()">üöÄ Test initializeBoldPayment()</button>
            <button onclick="clearLogs()">üßπ Limpiar Logs</button>
            <button onclick="testVariables()">üîç Test Variables PHP</button>
        </div>

        <div class="test-section">
            <h2>üìã Logs de Debug</h2>
            <div id="debug-logs" class="log">Logs aparecer√°n aqu√≠...</div>
        </div>
    </div>

    <script>
        // Variable de monto simulada (como en el PHP real)
        const montoFromPHP = <?php echo json_encode(150000); ?>;
        
        // Funci√≥n de log personalizada
        function debugLog(message) {
            const logDiv = document.getElementById('debug-logs');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        // Test de variables PHP
        function testVariables() {
            debugLog('üîç TEST: Verificando variables PHP...');
            debugLog(`‚úÖ montoFromPHP: ${montoFromPHP} (${typeof montoFromPHP})`);
            debugLog(`‚úÖ Es n√∫mero v√°lido: ${Number.isFinite(montoFromPHP)}`);
        }

        // Funci√≥n initializeBoldPayment simplificada para test
        function initializeBoldPayment() {
            debugLog('üöÄ initializeBoldPayment() llamada - PRIMER LOG');
            
            try {
                debugLog('üîß Intentando obtener container...');
                let container = document.getElementById('bold-payment-container');
                if (!container) {
                    // Crear container si no existe
                    container = document.createElement('div');
                    container.id = 'bold-payment-container';
                    document.getElementById('info_pago').appendChild(container);
                    debugLog('‚úÖ Container Bold creado din√°micamente');
                } else {
                    debugLog('‚úÖ Container Bold encontrado');
                }

                debugLog('üîß Intentando mostrar loading...');
                container.innerHTML = '<div style="text-align: center; padding: 16px; color: #007aff;">Preparando pago seguro...</div>';
                debugLog('‚úÖ Loading mostrado');

                // Generar ID √∫nico para la orden
                const orderId = 'SEQ-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                debugLog(`‚úÖ ID orden generado: ${orderId}`);
            
                // Obtener el monto del pedido con manejo seguro
                debugLog('üîç DEBUG: Obteniendo monto...');
                let monto = montoFromPHP;
                debugLog(`‚úÖ Monto desde PHP: ${monto} Tipo: ${typeof monto}`);
                
                // Si no hay monto del PHP, intentar obtenerlo del campo del formulario
                if (!monto || monto === 0) {
                    debugLog('üîß Intentando obtener monto del formulario...');
                    const montoField = document.querySelector('input[name="monto"]');
                    if (montoField && montoField.value) {
                        // Remover formato de moneda y convertir a n√∫mero
                        const rawValue = montoField.value.replace(/[^\d]/g, '');
                        monto = parseInt(rawValue) || 0;
                        debugLog(`‚úÖ Monto desde formulario: ${monto}`);
                    }
                }

                // Obtener el m√©todo de pago seleccionado
                const metodoPago = document.getElementById('metodo_pago').value;
                debugLog(`‚úÖ M√©todo de pago: ${metodoPago}`);
                
                debugLog(`üîß Preparando Bold con m√©todo: ${metodoPago}, monto: ${monto}`);
                
                // Validar que hay un monto v√°lido
                if (!monto || monto === 0) {
                    debugLog('‚ö†Ô∏è Inicializando Bold con checkout abierto (sin monto espec√≠fico)');
                    monto = 0;
                }
                
                debugLog(`üí∞ Monto final para Bold: ${monto}`);
                
                debugLog('üîÑ Iniciando proceso de preparaci√≥n Bold...');
                
                // Obtener datos del cliente del formulario
                const customerData = {
                    email: document.querySelector('input[name="correo"]')?.value || '',
                    fullName: document.querySelector('input[name="nombre"]')?.value || '',
                    phone: document.querySelector('input[name="telefono"]')?.value || '',
                    dialCode: '+57'
                };
                debugLog(`üë§ Datos del cliente: ${JSON.stringify(customerData)}`);

                // Datos de direcci√≥n de facturaci√≥n
                const billingAddress = {
                    address: document.querySelector('input[name="direccion"]')?.value || '',
                    city: 'Bogot√°',
                    state: 'Cundinamarca',
                    country: 'CO'
                };
                debugLog(`üìç Direcci√≥n de facturaci√≥n: ${JSON.stringify(billingAddress)}`);

                debugLog('‚úÖ Test de initializeBoldPayment completado exitosamente!');
                
                // Simular √©xito visual
                setTimeout(() => {
                    container.innerHTML = '<div style="text-align: center; padding: 16px; color: #00ff00;">‚úÖ Test completado - Funci√≥n funciona correctamente</div>';
                }, 1000);
                
                return true;
                
            } catch (error) {
                debugLog(`‚ùå ERROR en initializeBoldPayment: ${error.message}`);
                debugLog(`‚ùå Stack trace: ${error.stack}`);
                return false;
            }
        }

        // Test directo de la funci√≥n
        function testBoldFunction() {
            debugLog('üéØ Iniciando test manual de initializeBoldPayment...');
            
            // Asegurar que el m√©todo de pago est√© seleccionado
            const metodoPago = document.getElementById('metodo_pago');
            if (!metodoPago.value) {
                metodoPago.value = 'PSE Bold';
                debugLog('üîß M√©todo de pago establecido a PSE Bold');
            }
            
            // Crear info_pago content
            const infoPago = document.getElementById('info_pago');
            infoPago.innerHTML = `
                <div class="pse-bold-container">
                    <b>PSE Bold - Pago Seguro:</b>
                    <p style="color: #999; margin: 8px 0;">Pague de manera segura sin salir de esta p√°gina</p>
                    <div id="bold-payment-container" style="margin-top: 12px;"></div>
                </div>
            `;
            
            // Ejecutar funci√≥n
            const result = initializeBoldPayment();
            debugLog(`üéØ Resultado del test: ${result}`);
        }

        // Limpiar logs
        function clearLogs() {
            document.getElementById('debug-logs').innerHTML = 'Logs limpiados...\n';
        }

        // Event listener para m√©todo de pago
        document.getElementById('metodo_pago').addEventListener('change', function() {
            const value = this.value;
            debugLog(`üî• M√©todo de pago cambiado a: ${value}`);
            
            if (value === 'PSE Bold' || value === 'Bot√≥n Bancolombia' || value === 'Tarjeta de Cr√©dito o D√©bito') {
                const infoPago = document.getElementById('info_pago');
                infoPago.innerHTML = `
                    <div class="pse-bold-container">
                        <b>${value} - Pago Seguro:</b>
                        <p style="color: #999; margin: 8px 0;">Pague de manera segura sin salir de esta p√°gina</p>
                        <div id="bold-payment-container" style="margin-top: 12px;"></div>
                    </div>
                `;
                
                setTimeout(() => {
                    debugLog('‚è∞ Auto-ejecutando initializeBoldPayment...');
                    initializeBoldPayment();
                }, 100);
            }
        });

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('üìã P√°gina de test cargada');
            testVariables();
        });
    </script>
</body>
</html>
